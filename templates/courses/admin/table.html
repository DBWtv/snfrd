{% extends "courses/table.html" %}
{% load static %}

{% block add_coll_btn %}
    <th>
        <button class="btn" id="addCol">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 20 20"><path fill="#888888" d="M11 7v2H3v2h8v2l3-3l-3-3zm4-4.4v14.8c0 .551.448.6 1 .6c.553 0 1-.049 1-.6V2.6c0-.553-.447-.6-1-.6c-.552 0-1 .047-1 .6z"/></svg>
        </button>
    </th>
{% endblock add_coll_btn %}


{% block add_row_btn %}
    <td>
        <button class="btn" id="addRow">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 20 20"><path fill="#888888" d="M13 11h-2V3H9v8H7l3 3l3-3zm4.4 4H2.6c-.552 0-.6.447-.6 1c0 .553.048 1 .6 1h14.8c.552 0 .6-.447.6-1c0-.553-.048-1-.6-1z"/></svg>
        </button>
    </td>
{% endblock add_row_btn %}


{% block add_cell_btn %}
    <button class="btn" id="addCell">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 20 20"><path fill="#888888" d="M10 1.6a8.4 8.4 0 1 0 0 16.8a8.4 8.4 0 0 0 0-16.8zm5 9.4h-4v4H9v-4H5V9h4V5h2v4h4v2z"/></svg>
    </button>
{% endblock add_cell_btn %}

{% block table_scripts %}
    <script>

        function addRowRequest(week_id) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/class/api/add_row/", false);  // Устанавливаем параметр false для синхронного режима
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

            // Формируем тело запроса
            var data = 'week_id=' + encodeURIComponent(week_id) +
                    '&course_id=' + encodeURIComponent('{{ course.id }}') +
                    '&csrfmiddlewaretoken=' + encodeURIComponent('{{ csrf_token }}');

            xhr.send(data);

            if (xhr.status === 201) {
                return true;
            } else {
                throw new Error(xhr.status + ': ' + xhr.statusText);
            }
        }

        function addRow(weekCell, numCols, table) {
            // Создаем новую строку
            var newRow = $('<tr>');

            var cellHTML = $('#emptyCell').html();

            // Добавляем ячейки с данными
            for (var i = 1; i < numCols; i++) {
                if (i != 1) {
                    newRow.append('<td>' + cellHTML + '</td>');
                } else {
                    newRow.append('<td class="calendarWeekCell">' + weekCell + '</td>');
                }
            }

            // Добавляем новую строку в конец таблицы
            table.append(newRow);

            // Копируем содержимое последней строки
            var lastRowContent = $('#lastRow').html();

            // Удаляем существующую кнопку
            $('#lastRow').remove();

            // Добавляем новую строку с содержимым последней строки
            table.append('<tr id="lastRow">' + lastRowContent + '</tr>');
        }


        function getEnableDays() {
            let xhr = new XMLHttpRequest();
            xhr.open('POST', '/class/api/enable_days/', false);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

            let data = 'course_id=' + encodeURIComponent('{{ course.id }}') +
                    '&csrfmiddlewaretoken=' + encodeURIComponent('{{csrf_token}}');
            
            xhr.send(data);

            return JSON.parse(xhr.responseText);
        }

        function updateTable(day_id) {
            let xhr = new XMLHttpRequest();
            xhr.open('POST', '/class/api/update_table/', async=false);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

            let data = 'course_id=' + encodeURIComponent('{{ course.id }}') +
                    '&csrfmiddlewaretoken=' + encodeURIComponent('{{csrf_token}}') + 
                    '&day_id=' + encodeURIComponent(day_id);
                
            xhr.send(data);

            if (xhr.status != 201) {
                throw new Error(xhr.status + ': ' + xhr.statusText);
            }

            return xhr.responseText;
        }

        function newCollonForm(days) {
            let html = $('<div class="form-group"></div>')
            let form = $('<form class="addColumnForm"></form>');
            let select = $('<select id="daySelected" name="day">');
            for (let i = 0; i < days.length; i++) {
                let option = $('<option>');
                option.attr('value', days[i].id);
                option.text(days[i].name);
                select.append(option);
            }
            let button = $('<button id="addColSubmit">add</button>');
            form.append(select);
            form.append(button);
            html.append(form);
            return html;
        }

        $(document).ready(function () {

            // Обработчик события нажатия кнопки
            $('#schedule').on('click', '#addRow', function () {

                // Выбираем таблицу и определяем количество столбцов
                var table = $('#schedule tbody');
                var numCols = $('#schedule thead th').length;

                var weekCell = $('#schedule tbody .calendarWeekCell').length + 1;

                try {
                    addRowRequest(weekCell)
                    addRow(weekCell, numCols, table);
                }
                catch (e) {
                    console.log(e);
                }

                });

            let table = $('<table id="schedule" class="table table-curved"></table>')
            
            $('#schedule').on('click', '#addCol', function () {
                let enabledDays = getEnableDays();
                if (enabledDays.length == 0) {
                    alert('Нет доступных дней для добавления');
                    return;
                } else {
                    let form = newCollonForm(enabledDays);
                    $('.table-responsive').empty();
                    $('.table-responsive').append(form);
                }
            });

            $('.table-responsive').on('click', '#addColSubmit', function (event) {
                event.preventDefault();
                day = $('#daySelected').val();
                try {
                    updateTable(day_id=day);
                    location.reload(true);
                } catch (e) {
                    alert(e);
                }
            });
        });

    </script>
{% endblock table_scripts %}
